---
title: "Kaplan-Meier Simulation Study"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
# Libraries
library(data.table)
library(survival)
#install.packages("rtmle")
#devtools::install_github("tagteam/rtmle")
library(rtmle)
library(ggplot2)
library(microbenchmark)
theme_set(theme_bw())
```

# Aim

The aim is to conduct a simulation study, where we investigate the Kaplan-Meier estimator. The estimand will be
$$S(\tau | A_0 = 1) = P(T \geq \tau | A_0 = 1) , \quad S(\tau | A_0 = 0) = P(T \geq \tau | A_0 = 0)$$
For some $\tau \in \RR$. $T$ is here the survival time *post* T2D diagnose. As mentioned the survival function will be estimated by the Kaplan-Meier estimator. Post T2D diagnose the setting is simpler, as there are no competing events, only death and censoring. The Kaplan-Meier estimator will then be an unbiased estimator of the survival probability. 

The true value of $P(T \geq \tau | A_0 = a_0)$ can be estimated by a Monte Carlo approach. That is by simulating a large data set without censoring, and calculating the proportion of dead at time $\tau$ post T2D diagnose, in respectively treatment and placebo group. 

After having estimated the true value, we generate $B$ data sets with $N$ individuals. For each data set we find the Kaplan-Meier estimate of $P(T \geq \tau | A_0 = a_0)$, the SE, and the upper and lower confidence bands. We check the bias of the estimate and the coverage of the Kaplan-Meier CI. 

We will use the following values of the parameters

```{r}
eta <- c(0.1,0.3,0.1,0.1)
nu <- c(1.1,1.3,1.1,1.1)
beta_L0_L <- 1.5
beta_A0_L <- -1
beta_L_D <- 0.9
beta_L0_D <- 0.6
beta_A0_D <- 0
```

# True estimate

We simulate the large data

```{r}
N <- 10^5
data_prop <- simT2D(N = N, eta = eta, nu = nu, sex = FALSE, beta_L0_D = beta_L0_D, beta_L0_L = beta_L0_L,
       beta_A0_L = beta_A0_L, beta_L_D = beta_L_D, beta_A0_D = beta_A0_D, cens = 0)
```

We calculate the proportion of dead $\tau = 1$ years post T2D diagnose

```{r}
tau <- 1

# T2D events
T2D_events <- data_prop[Delta == 3]

# T2D people
T2D_peeps <- data_prop[ID %in% T2D_events$ID]

# Setting T_0 to debut time of diabetes
T2D_peeps[, Time_T2D := Time - min(Time), by = ID]

# Removing the new Time 0
T2D_peeps <- T2D_peeps[Delta != 3]

# Proportion of treatment and placebo patients who have died before tau time after T2D diagnose
prop_treat <- nrow(T2D_peeps[Time_T2D < tau & A0 == 1]) / nrow(T2D_peeps[A0 == 1]) 
prop_plac <- nrow(T2D_peeps[Time_T2D < tau & A0 == 0]) / nrow(T2D_peeps[A0 == 0]) 

surv_prob1 <- 1 - prop_treat
surv_prob0 <- 1 - prop_plac
surv_prob1
surv_prob0
```

# Kaplan-Meier estimator

We now simulate data with censoring and calculate the Kaplan-Meier estimate of $P(T \geq \tau | A_0 = a_0)$. 

```{r}
N <- 500
B <- 1000
res <- matrix(nrow = B, ncol = 8)
colnames(res) <- c("Est 0", "Est 1", "SE 0", "SE 1", "Lower 0", "Lower 1", 
                   "Upper 0", "Upper 1")

for(b in 1:B){
  # Generate data
  data_boot <- simT2D(N = N, eta = eta, nu = nu, sex = FALSE, beta_L0_D = beta_L0_D, beta_L0_L = beta_L0_L,
       beta_A0_L = beta_A0_L, beta_L_D = beta_L_D, beta_A0_D = beta_A0_D, cens = 1)
  
  # T2D events
  T2D_events <- data_boot[Delta == 3]
  
  # T2D people
  T2D_peeps <- data_boot[ID %in% T2D_events$ID]
  
  # Setting T_0 to debut time of diabetes
  T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
  
  # Removing the new Time 0
  T2D_peeps <- T2D_peeps[Delta != 3]
  
  # Kaplan meyer fit
  boot_fit <- survfit(Surv(Time_T2D, Delta == 1) ~ A0, data = T2D_peeps)
  
  # Save estimate of survival probability, SE and confidence limits
  preds <- summary(boot_fit, times = tau, data.frame = TRUE)
  
  # The KM estimate, SE's, lower CI, and upper CI is returned
  res[b, ] <- (c(preds[,5], preds[,7], preds[,9], preds[,10]))
}
```

Bias

```{r}
c("A0 = 0" = mean(res[,'Est 0'] - surv_prob0) ,"A0 = 1" = mean(res[,'Est 1'] - surv_prob1)) |> 
  knitr::kable(col.names = "Bias")
```

Coverage

```{r}
c("A0 = 0" = mean(res[,'Lower 0'] <= surv_prob0 & surv_prob0 <= res[,'Upper 0']),
"A0 = 1" =  mean(res[,'Lower 1'] <= surv_prob1 &  surv_prob1 <= res[,'Upper 1'])) |> 
  knitr::kable(col.names = "Coverage")
```

Histograms of estimate

```{r}
plot_data <- data.table(ests = c(res[,'Est 0'], res[,'Est 1']),
                        A0 = c(rep(0, B), rep(1, B)),
                        true_val = c(rep(surv_prob0, B), rep(surv_prob1,B)))
ggplot(plot_data) +
  geom_histogram(aes(x = ests, y = ..density..), color = "white", fill = "steelblue")+
  geom_vline(aes(xintercept = true_val), color = "darkred")+
  facet_wrap(~A0)
```

